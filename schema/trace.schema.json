{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://example.com/schemas/trace.schema.json",
  "title": "User Action Trace",
  "type": "object",
  "required": ["version", "createdAt", "steps"],
  "properties": {
    "version": { "type": "string" },
    "createdAt": { "type": "string", "description": "ISO-8601 timestamp for when the trace file was created" },
    "startedAt": { "type": "string", "description": "ISO-8601 timestamp for when recording started (optional)" },
    "baseUrl": { "type": "string", "description": "Base site/origin used for replay (usually the origin of startUrl)" },
    "startUrl": { "type": "string", "description": "The full URL of the active tab when Start was pressed" },
    "startOrigin": { "type": "string", "description": "Origin of startUrl (protocol+host+port)" },
    "startTitle": { "type": "string", "description": "Tab title when Start was pressed" },
    "metadata": {
      "type": "object",
      "properties": {
        "userAgent": { "type": "string" },
        "viewport": {
          "type": "object",
          "properties": {
            "width": { "type": "integer" },
            "height": { "type": "integer" },
            "deviceScaleFactor": { "type": "number" }
          },
          "required": ["width", "height"],
          "additionalProperties": true
        }
      },
      "additionalProperties": true
    },
    "steps": {
      "type": "array",
      "items": { "$ref": "#/$defs/step" },
      "minItems": 1
    }
  },
  "additionalProperties": false,
  "$defs": {
    "selector": {
      "description": "A selector alternative. Either a CSS string or typed locator.",
      "oneOf": [
        { "type": "string" },
        {
          "type": "object",
          "required": ["type", "value"],
          "properties": {
            "type": { "type": "string", "enum": ["css", "text", "aria", "xpath"] },
            "value": { "type": "string" },
            "description": { "type": "string" }
          },
          "additionalProperties": false
        }
      ]
    },
    "selectors": {
      "type": "array",
      "items": { "$ref": "#/$defs/selector" },
      "minItems": 1
    },
    "step": {
      "type": "object",
      "required": ["type", "ts"],
      "properties": {
        "type": {
          "type": "string",
          "enum": ["navigate", "click", "type", "change", "select", "scroll", "wait", "submit", "hover", "key"]
        },
        "ts": { "type": "number", "description": "Milliseconds since recording started (relative ms)" },
        "frame": { "type": "string" },
        "note": { "type": "string" },
        "assert": { "type": "object" }
      },
      "allOf": [
        {
          "if": { "properties": { "type": { "const": "navigate" } } },
          "then": {
            "required": ["url"],
            "properties": { "url": { "type": "string" } }
          }
        },
        {
          "if": { "properties": { "type": { "const": "click" } } },
          "then": {
            "required": ["selectors"],
            "properties": {
              "selectors": { "$ref": "#/$defs/selectors" },
              "button": { "type": "string", "enum": ["left", "middle", "right"], "default": "left" },
              "modifiers": { "type": "array", "items": { "type": "string", "enum": ["Alt", "Control", "Meta", "Shift"] } },
              "x": { "type": "number" },
              "y": { "type": "number" }
            }
          }
        },
        {
          "if": { "properties": { "type": { "const": "type" } } },
          "then": {
            "required": ["selectors", "text"],
            "properties": {
              "selectors": { "$ref": "#/$defs/selectors" },
              "text": { "type": "string" },
              "submit": { "type": "boolean" }
            }
          }
        },
        {
          "if": { "properties": { "type": { "const": "change" } } },
          "then": {
            "required": ["selectors", "value"],
            "properties": {
              "selectors": { "$ref": "#/$defs/selectors" },
              "value": { "type": "string" }
            }
          }
        },
        {
          "if": { "properties": { "type": { "const": "select" } } },
          "then": {
            "required": ["selectors", "value"],
            "properties": {
              "selectors": { "$ref": "#/$defs/selectors" },
              "value": { "oneOf": [ {"type": "string"}, {"type": "array", "items": {"type": "string"}, "minItems": 1 } ] }
            }
          }
        },
        {
          "if": { "properties": { "type": { "const": "scroll" } } },
          "then": {
            "required": ["target", "x", "y"],
            "properties": {
              "target": { "type": "string", "enum": ["window", "element"] },
              "x": { "type": "number" },
              "y": { "type": "number" },
              "selectors": { "$ref": "#/$defs/selectors" }
            }
          }
        },
        {
          "if": { "properties": { "type": { "const": "wait" } } },
          "then": {
            "required": ["for"],
            "properties": {
              "for": {
                "type": "object",
                "oneOf": [
                  {
                    "required": ["selector"],
                    "properties": {
                      "selector": { "type": "string" },
                      "state": { "type": "string", "enum": ["visible", "attached", "hidden"] }
                    },
                    "additionalProperties": false
                  },
                  { "required": ["url"], "properties": { "url": { "type": "string" } }, "additionalProperties": false },
                  { "required": ["ms"], "properties": { "ms": { "type": "number" } }, "additionalProperties": false },
                  { "required": ["networkIdle"], "properties": { "networkIdle": { "const": true } }, "additionalProperties": false }
                ]
              }
            }
          }
        }
        ,
        {
          "if": { "properties": { "type": { "const": "submit" } } },
          "then": {
            "required": ["formSelectors"],
            "properties": {
              "formSelectors": { "$ref": "#/$defs/selectors" },
              "submitterSelectors": { "$ref": "#/$defs/selectors" }
            }
          }
        }
        ,
        {
          "if": { "properties": { "type": { "const": "hover" } } },
          "then": {
            "required": ["selectors"],
            "properties": {
              "selectors": { "$ref": "#/$defs/selectors" },
              "x": { "type": "number" },
              "y": { "type": "number" }
            }
          }
        }
        ,
        {
          "if": { "properties": { "type": { "const": "key" } } },
          "then": {
            "required": ["key"],
            "properties": {
              "key": { "type": "string" },
              "action": { "type": "string", "enum": ["press","down","up"], "default": "press" },
              "modifiers": { "type": "array", "items": { "type": "string", "enum": ["Alt", "Control", "Meta", "Shift"] } },
              "repeat": { "type": "boolean" },
              "selectors": { "$ref": "#/$defs/selectors" }
            }
          }
        }
      ],
      "additionalProperties": true
    }
  }
}
